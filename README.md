# AwesomeISP

Интерактивная карта коммутаторов, отображаемая в браузере с функцией автообнаружения по LLDP.

Для конечного пользователя это будет выглядеть как простая страница с картой и ничего
более. Зеленым цветом отображаются устройства которые доступны (отвечают на SNMP-запросы), красным 
цветом те, которые недоступны.

![Map preview](map_preview.png)

При наведении указателя мыши на какую-то из точек показывается дополнительная
информация: ip-адрес и модель.

Сервис в фоновом режиме постоянно сканирует сеть (диапазон ip-адресов задается
в конфиге) и при обнаружении новых устройств добавляет их на карту.

## Запуск

Все до безобразия просто:
1. В `docker-compose.yml` указать:
    1. SNMP-comunity в параметре `READ_COMMUNITY` 
    2. блоки сетей из которых опрашивать устройства в парметре `NETWORKS_TO_DISCOVER` (через запятую)
    3. период через который будут запускаться задачи обнаружения хостов в параметре `SCHEDULE_TIME` в секундах 
2. Запустить контейнеры с помощью `docker-compose up -d --scale worker=3`.

## Как это работает изнутри?

Демон берет из конфига диапазон ip-адресов и методично начинает проверять каждый ip-адрес
путем посылки SNMP-запроса на получение локального LLDP ChassisID. Если ответ получен, то шлет дополнительные
запросы, что бы определить модель устройства.

Отдельная задача выбирает все хосты из БД и для каждого из них получает LLDP соседей, занося информацию о их ChassisID
в БД. Таким образом, имея на руках информацию LLDP с каждого устройства мы может построить карту сети. Делается 
это отдельной задачей, которая формирует файлик с хостами и связями в виде JSON.

На web-интерфейсе файлик с JSON разбирается небольшим скриптом на JS и с помощью [D3.js](https://d3js.org)
отрисовывается на страничке.

### Состав системы

Все построено на базе Celery и упаковано в Docker. Система состоит из следующих сервисов:
* **beat** - шедулер, который запускает команды на выполнение
* **worker** - код, который непосредственно исполняет команды
* **rabbitmq** - брокер для сообщений
* **mongo** - инстанс MongoDb для хранения информации о хостах
* **web** - контейнер с nginx и страничкой для отображения карты, слушает на порту 8080
* **flower** - web-интерфейс для наблюдения за состоянием исполнения задач
 